@using System.Globalization
@model SystemPurchaseAccGame.ViewModel.AccountPurchaseDto

@{
    Layout = "~/Views/Shared/_ClientNewLayout.cshtml";
    var vi = new CultureInfo("vi-VN");

    var imgs = (Model.Media ?? new List<SystemPurchaseAccGame.ViewModel.MediaDto>())
        .Where(m => !string.IsNullOrWhiteSpace(m.Url))
        .OrderBy(m => m.SortOrder)
        .ToList();
}

<style>
    /* Modal tối thiểu để chắc chắn hiện (nếu project chưa có CSS modal) */
    .acc_detail_pay_modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 16px;
    }

    .acc_detail_pay_modalCard {
        width: min(560px, 100%);
        background: #fff;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0,0,0,.25);
    }

    .acc_detail_pay_modalTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-bottom: 1px solid #eee;
    }

    .acc_detail_pay_modalTitle {
        font-weight: 800;
    }

    .acc_detail_pay_modalClose {
        border: 0;
        background: transparent;
        font-size: 18px;
        padding: 6px 10px;
        cursor: pointer;
    }
</style>

<main class="container my-4">
    <div class="ap-card p-3 p-lg-4 bg-white rounded-4 shadow-sm border text-center">

        <!-- TÊN -->
        <h1 class="ap-title fw-bold text-uppercase mb-2">@Model.Title</h1>

        <!-- MÔ TẢ -->
        <div class="ap-desc mb-3 text-muted fw-semibold">
            @(string.IsNullOrWhiteSpace(Model.Description) ? "Mô tả đang cập nhật..." : Model.Description)
        </div>

        <!-- GIÁ + MUA -->
        <div class="ap-buy d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-between gap-3 p-3 rounded-4 border mb-4">
            <div class="ap-price">
                <div class="ap-price__label text-muted fw-bold">Giá</div>
                <div class="ap-price__value fw-black">@Model.Price.ToString("N0", vi) ₫</div>
            </div>

            <a id="acc_detail_pay_btnBuy"
               href="#"
               class="ap-buy__btn btn btn-primary btn-lg fw-bold px-4 w-100 w-sm-auto"
               data-account-id="@Model.AccountId">
                <i class="fa-solid fa-cart-shopping me-2"></i>Mua ngay
            </a>
        </div>

        <!-- ẢNH -->
        <div class="ap-section-title fw-black mb-3">Ảnh chi tiết</div>

        @if (imgs.Any())
        {
            <div class="d-grid gap-3">
                @foreach (var img in imgs)
                {
                    <img src="@img.Url"
                         alt="Ảnh sản phẩm"
                         class="ap-img w-100 rounded-4 border"
                         loading="lazy" />
                }
            </div>
        }
        else
        {
            <div class="text-muted fw-semibold">Chưa có ảnh.</div>
        }
    </div>
</main>

<!-- host để nhét partial modal -->
<div id="acc_detail_pay_modalHost"></div>

@Html.AntiForgeryToken()

<script>
    (() => {
      const host = document.getElementById("acc_detail_pay_modalHost");
      const btnBuy = document.getElementById("acc_detail_pay_btnBuy");

      function getCsrfToken() {
        const el = document.querySelector('input[name="__RequestVerificationToken"]');
        return el ? el.value : "";
      }

      function closeModal() {
        host.innerHTML = "";
        document.body.style.overflow = "";
        window.removeEventListener("keydown", onEscClose);
      }

      function onEscClose(e) {
        if (e.key === "Escape") closeModal();
      }

      function mountModal(html) {
        host.innerHTML = html || "";
        if (!html) return;

        document.body.style.overflow = "hidden";
        window.addEventListener("keydown", onEscClose);

        // close buttons
        host.querySelectorAll(".js-close-modal").forEach(b => {
          b.addEventListener("click", closeModal);
        });

        // click overlay to close
        const overlay = host.querySelector(".acc_detail_pay_modal");
        if (overlay) {
          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) closeModal();
          });
        }

        // confirm pay button
        const btnConfirm = host.querySelector(".js-confirm-pay");
        if (btnConfirm) {
          btnConfirm.addEventListener("click", async () => {
            const accountId = btnConfirm.getAttribute("data-account-id");
            if (!accountId) { alert("Thiếu accountId."); return; }

            const res = await fetch("/Order/ConfirmPay", {
              method: "POST",
              credentials: "same-origin",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
                "X-Requested-With": "XMLHttpRequest"
              },
              body: new URLSearchParams({
                "__RequestVerificationToken": getCsrfToken(),
                "accountId": accountId
              })
            });

            const text = await res.text();
            let data = null;
            try { data = JSON.parse(text); } catch {}

            if (res.status === 401) {
              alert(data?.message || "Bạn cần đăng nhập.");
              if (data?.redirectUrl) window.location.href = data.redirectUrl;
              return;
            }

            if (!res.ok || !data?.ok) {
              alert(data?.message || "Thanh toán thất bại.");
              return;
            }

            alert(data.message || "Thanh toán thành công!");
            closeModal();
            if (data.redirectUrl) window.location.href = data.redirectUrl;
          });
        }
      }

      async function postJsonExpectModal(url, bodyObj) {
        const res = await fetch(url, {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
            "X-Requested-With": "XMLHttpRequest"
          },
          body: new URLSearchParams({
            "__RequestVerificationToken": getCsrfToken(),
            ...bodyObj
          })
        });

        const text = await res.text();
        let data = null;
        try { data = JSON.parse(text); } catch {}

        // nếu server trả html/redirect -> show debug
        if (!data) {
          console.log("Response is not JSON:", text);
          alert("Response không phải JSON. Vui lòng xem Network/Console.");
          return;
        }

        if (res.status === 401) {
          alert(data?.message || "Bạn cần đăng nhập.");
          if (data?.redirectUrl) window.location.href = data.redirectUrl;
          return;
        }

        if (!res.ok || !data.ok) {
          alert(data?.message || "Có lỗi xảy ra.");
          return;
        }

        mountModal(data.html);
      }

      if (btnBuy) {
        btnBuy.addEventListener("click", async (e) => {
          e.preventDefault();

          const id = btnBuy.getAttribute("data-account-id");
          if (!id) { alert("Không tìm thấy AccountId."); return; }

          await postJsonExpectModal("/Order/PreparePay", { id });
        });
      }
    })();
</script>