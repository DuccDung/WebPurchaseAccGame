@{
    Layout = "~/Views/Shared/_ClientLayout.cshtml";
}

<style>
    .wheel-wrap {
        max-width: 520px;
        margin: 24px auto;
        padding: 16px;
    }

    .wheel-box {
        position: relative;
        border-radius: 16px;
        padding: 16px;
        background: #111;
        color: #fff;
    }

    canvas {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 50%;
        background: #222;
    }

    .pointer {
        position: absolute;
        top: 6px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 14px solid transparent;
        border-right: 14px solid transparent;
        border-bottom: 26px solid #ffd54f;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,.6));
        z-index: 2;
    }

    .actions {
        display: flex;
        gap: 12px;
        margin-top: 14px;
        justify-content: center;
    }

    .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
</style>

<div class="wheel-wrap">
    <div class="wheel-box">
        <div class="pointer"></div>
        <canvas id="wheel" width="520" height="520"></canvas>

        <div class="actions">
            <button class="btn btn-warning" id="btnSpin">🎡 Quay ngay</button>
        </div>
    </div>
</div>

<!-- ✅ MODAL KẾT QUẢ -->
<div class="modal fade" id="spinResultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="mTitle">Kết quả vòng quay</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="mb-2 fw-bold" id="mPrizeTitle">---</div>
                <div class="text-muted mb-3" id="mMsg">---</div>

                <div class="p-3 rounded-3" style="background:#111; border:1px solid rgba(255,255,255,.12);">
                    <div class="d-flex justify-content-between align-items-center gap-2 mb-2">
                        <div class="mono" id="mUser">USER: ---</div>
                        <button class="btn btn-outline-light btn-sm" type="button" id="btnCopyUser">Copy</button>
                    </div>
                    <div class="d-flex justify-content-between align-items-center gap-2">
                        <div class="mono" id="mPass">PASS: ---</div>
                        <button class="btn btn-outline-light btn-sm" type="button" id="btnCopyPass">Copy</button>
                    </div>
                    <hr style="border-color: rgba(255,255,255,.12);" />
                    <div class="d-flex justify-content-between align-items-center gap-2">
                        <div class="mono" id="mAll">acc/pass</div>
                        <button class="btn btn-primary btn-sm" type="button" id="btnCopyAll">Copy acc/pass</button>
                    </div>
                </div>

                <div class="alert alert-warning mt-3 mb-0">
                    <i class="fa fa-triangle-exclamation me-2"></i>
                    Hãy lưu lại tài khoản. Đóng popup để tiếp tục.
                </div>
            </div>

            <div class="modal-footer border-0">
                <button class="btn btn-outline-light" type="button" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- nếu layout chưa có bootstrap bundle thì bật dòng này -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    (() => {
      const canvas = document.getElementById("wheel");
      const ctx = canvas.getContext("2d");
      const btnSpin = document.getElementById("btnSpin");

      // modal
      const modalEl = document.getElementById("spinResultModal");
      const modal = window.bootstrap ? window.bootstrap.Modal.getOrCreateInstance(modalEl) : null;

      const mPrizeTitle = document.getElementById("mPrizeTitle");
      const mMsg = document.getElementById("mMsg");
      const mUser = document.getElementById("mUser");
      const mPass = document.getElementById("mPass");
      const mAll = document.getElementById("mAll");

      const btnCopyUser = document.getElementById("btnCopyUser");
      const btnCopyPass = document.getElementById("btnCopyPass");
      const btnCopyAll = document.getElementById("btnCopyAll");

      let items = [];
      let angle = 0;
      let spinning = false;
      let pendingReload = false; // ✅ chỉ reload sau khi đóng modal

      function randColor(i){
        const colors = ["#4fc3f7","#81c784","#ffb74d","#ba68c8","#e57373","#64b5f6","#ffd54f","#4db6ac"];
        return colors[i % colors.length];
      }

      function drawWheel(){
        const W = canvas.width, H = canvas.height;
        const cx = W/2, cy = H/2;
        const r = Math.min(W,H)/2 - 10;

        ctx.clearRect(0,0,W,H);

        if(items.length === 0){
          ctx.fillStyle = "#fff";
          ctx.font = "20px sans-serif";
          ctx.fillText("Chưa có phần thưởng", 160, 260);
          return;
        }

        const n = items.length;
        const slice = (Math.PI * 2) / n;

        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(angle);

        for(let i=0;i<n;i++){
          ctx.beginPath();
          ctx.moveTo(0,0);
          ctx.arc(0,0,r,i*slice,(i+1)*slice);
          ctx.closePath();
          ctx.fillStyle = randColor(i);
          ctx.fill();

          ctx.save();
          ctx.rotate(i*slice + slice/2);
          ctx.fillStyle = "#111";
          ctx.font = "bold 16px sans-serif";
          ctx.textAlign = "right";
          ctx.fillText(items[i].label, r - 18, 6);
          ctx.restore();
        }

        // center
        ctx.beginPath();
        ctx.arc(0,0,70,0,Math.PI*2);
        ctx.fillStyle = "#111";
        ctx.fill();

        ctx.fillStyle = "#fff";
        ctx.font = "bold 18px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("SPIN", 0, 6);

        ctx.restore();
      }

      async function loadItems(){
        const res = await fetch("/api/luckyspin/items", { cache: "no-store" });
        if(!res.ok){
          items = [];
          drawWheel();
          alert("Không tải được phần thưởng. Status: " + res.status);
          return;
        }

        const json = await res.json();
        if(!json?.ok){
          items = [];
          drawWheel();
          alert(json?.message || "Không tải được phần thưởng");
          return;
        }

        items = json.items || [];
        angle = 0;
        drawWheel();
      }

      function animateToIndex(index){
        const n = items.length;
        const slice = (Math.PI*2)/n;
        const target = (Math.PI * 1.5) - (index*slice + slice/2);
        const extraTurns = Math.PI*2 * (4 + Math.floor(Math.random()*3));
        const start = angle;
        const end = target + extraTurns;

        const duration = 3200;
        const t0 = performance.now();

        function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }

        return new Promise((resolve) => {
          function step(t){
            const p = Math.min(1, (t - t0)/duration);
            angle = start + (end - start) * easeOutCubic(p);
            drawWheel();
            if(p < 1) requestAnimationFrame(step);
            else {
              angle = target;
              drawWheel();
              resolve();
            }
          }
          requestAnimationFrame(step);
        });
      }

      function escapeHtml(s){
        return String(s)
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      async function copyText(text, btn){
        if(!text) return;

        try{
          await navigator.clipboard.writeText(text);
          const old = btn.innerHTML;
          btn.innerHTML = "✅";
          setTimeout(() => btn.innerHTML = old, 800);
        }catch{
          alert("Không copy được. Trình duyệt không cho phép.");
        }
      }

      async function spin(){
        if(spinning) return;
        if(items.length === 0) return alert("Chưa có phần thưởng.");

        spinning = true;
        btnSpin.disabled = true;
        pendingReload = false;

        const res = await fetch("/api/luckyspin/spin", { method:"POST" });
        const json = await res.json();

        if(!json?.ok){
          spinning = false;
          btnSpin.disabled = false;
          return alert(json?.message || "Quay thất bại");
        }

        // nếu server trả index vượt mảng thì reload items để đồng bộ
        if(json.index == null || json.index < 0 || json.index >= items.length){
          await loadItems();
        }

        // quay animation xong rồi mới show modal
        await animateToIndex(json.index);

        // fill modal
        const p = json.prize || {};
        const title = p.title || "Bạn trúng thưởng!";
        const msg = json.message || "";
        const u = p.user || "";
        const pw = p.pass || "";

        mPrizeTitle.textContent = "🎉 " + title;
        mMsg.textContent = msg;

        mUser.innerHTML = "USER: <b>" + escapeHtml(u) + "</b>";
        mPass.innerHTML = "PASS: <b>" + escapeHtml(pw) + "</b>";
        mAll.innerHTML = "<b>" + escapeHtml(`${u}/${pw}`) + "</b>";

        // bật copy buttons
        btnCopyUser.onclick = () => copyText(u, btnCopyUser);
        btnCopyPass.onclick = () => copyText(pw, btnCopyPass);
        btnCopyAll.onclick  = () => copyText(`${u}/${pw}`, btnCopyAll);

        // ✅ đánh dấu cần reload sau khi người dùng đóng modal
        pendingReload = true;

        // show modal
        if(modal) modal.show();
        else alert(`${title}\n${msg}\n${u}/${pw}`);

        spinning = false;
        btnSpin.disabled = false;
      }

      // ✅ đóng modal xong mới reload wheel để item hết Remaining biến mất
      modalEl?.addEventListener("hidden.bs.modal", async () => {
        if(pendingReload){
          pendingReload = false;
          await loadItems();
        }
      });

      btnSpin.addEventListener("click", spin);

      loadItems();
    })();
</script>