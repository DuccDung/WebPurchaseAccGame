@using SystemPurchaseAccGame.ViewModel
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    // Stats
    long revenueMonth = Convert.ToInt64(ViewBag.RevenueMonth ?? 0);
    long soldCountMonth = Convert.ToInt64(ViewBag.SoldCountMonth ?? 0);

    // Tables
    var pendingTopups = ViewBag.PendingTopups as List<AdminTopupVm> ?? new List<AdminTopupVm>();
    var recentPaidOrders = ViewBag.RecentPaidOrders as List<dynamic> ?? new List<dynamic>();
    // recentPaidOrders: { OrderId, UserName, TotalAmount, PaidAt/CreatedAt }
}

<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <!-- Revenue Month -->
        <div class="col-sm-6 col-xl-3">
            <div class="bg-secondary rounded d-flex align-items-center justify-content-between p-4">
                <i class="fa fa-chart-line fa-3x text-primary"></i>
                <div class="ms-3">
                    <p class="mb-2">Doanh thu tháng</p>
                    <h6 class="mb-0">@("₫" + revenueMonth.ToString("N0"))</h6>
                    <small class="text-muted">Chỉ tính đơn PAID trong tháng</small>
                </div>
            </div>
        </div>

        <!-- Sold Month -->
        <div class="col-sm-6 col-xl-3">
            <div class="bg-secondary rounded d-flex align-items-center justify-content-between p-4">
                <i class="fa fa-chart-bar fa-3x text-primary"></i>
                <div class="ms-3">
                    <p class="mb-2">Tài khoản bán ra</p>
                    <h6 class="mb-0">@soldCountMonth.ToString("N0")</h6>
                    <small class="text-muted">Số đơn PAID trong tháng</small>
                </div>
            </div>
        </div>

        <!-- Pending Topup Count -->
        <div class="col-sm-6 col-xl-3">
            <div class="bg-secondary rounded d-flex align-items-center justify-content-between p-4">
                <i class="fa fa-hourglass-half fa-3x text-primary"></i>
                <div class="ms-3">
                    <p class="mb-2">Nạp tiền chờ duyệt</p>
                    <h6 class="mb-0">@pendingTopups.Count.ToString("N0")</h6>
                    <small class="text-muted">Topup PENDING</small>
                </div>
            </div>
        </div>

        <!-- Pending Topup Total -->
        <div class="col-sm-6 col-xl-3">
            <div class="bg-secondary rounded d-flex align-items-center justify-content-between p-4">
                <i class="fa fa-wallet fa-3x text-primary"></i>
                <div class="ms-3">
                    <p class="mb-2">Tổng tiền chờ duyệt</p>
                    <h6 class="mb-0">
                        @("₫" + pendingTopups.Sum(x => x.Amount).ToString("N0"))
                    </h6>
                    <small class="text-muted">Tổng Amount khai báo</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Topup Pending Table -->
<div class="container-fluid pt-4 px-4">
    <div class="bg-secondary text-center rounded p-4">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <h6 class="mb-0">Khách hàng nạp tiền (PENDING)</h6>
            <a href="/Admin/ConfirmPayment">Đi tới duyệt nạp</a>
        </div>

        <div class="table-responsive">
            <table class="table text-start align-middle table-bordered table-hover mb-0">
                <thead>
                    <tr class="text-white">
                        <th scope="col" style="width:40px">
                            <input class="form-check-input" type="checkbox" />
                        </th>
                        <th scope="col">Mã khách hàng</th>
                        <th scope="col">Họ và tên</th>
                        <th scope="col" class="text-end">Số tiền nạp</th>
                        <th scope="col">Loại (ATM/Card)</th>
                        <th scope="col">Trạng thái</th>
                        <th scope="col">Kiểm tra</th>
                    </tr>
                </thead>

                <tbody>
                    @if (pendingTopups.Count == 0)
                    {
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                Không có yêu cầu nạp tiền đang chờ.
                            </td>
                        </tr>
                    }
                    else
                    {
                        foreach (var t in pendingTopups.Take(10))
                        {
                            var methodUpper = (t.Method ?? "").ToUpper();
                            var methodText = methodUpper == "BANK" ? "ATM/BANK" :
                            (methodUpper == "CARD" || methodUpper == "CARD" ? "CARD" : t.Method);

                            <tr>
                                <td><input class="form-check-input" type="checkbox" /></td>
                                <td>@t.UserId</td>
                                <td class="text-start">
                                    <div class="fw-semibold">@t.UserName</div>
                                    <small class="text-muted">@t.Email • @t.Phone</small>
                                </td>
                                <td class="text-end">@("₫" + t.Amount.ToString("N0"))</td>
                                <td>@methodText</td>
                                <td>
                                    <span class="badge bg-warning text-dark">@t.Status</span>
                                </td>
                                <td>
                                    <a class="btn btn-sm btn-primary" id="detail_payment_user">
                                        Detail
                                    </a>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        @if (pendingTopups.Count > 10)
        {
            <div class="text-muted small mt-3">
                Đang hiển thị 10/@pendingTopups.Count yêu cầu • Bấm “Đi tới duyệt nạp” để xem tất cả.
            </div>
        }
    </div>
</div>

<!-- Widgets -->
<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <!-- Messages (placeholder) -->
        <div class="col-sm-12 col-md-6 col-xl-4">
            <div class="h-100 bg-secondary rounded p-4">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="mb-0">Messages</h6>
                    <a href="javascript:void(0)">Show All</a>
                </div>

                <div class="text-muted">
                    Bạn có thể thay phần này bằng thông báo hệ thống / log admin sau.
                </div>
            </div>
        </div>

        <!-- Calendar (template) -->
        <div class="col-sm-12 col-md-6 col-xl-4">
            <div class="h-100 bg-secondary rounded p-4">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h6 class="mb-0">Calender</h6>
                    <a href="javascript:void(0)">Show All</a>
                </div>
                <div id="calender"></div>
            </div>
        </div>

        <!-- Recent Paid Orders -->
        <div class="col-sm-12 col-md-6 col-xl-4">
            <div class="h-100 bg-secondary rounded p-4">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h6 class="mb-0">Khách hàng mua (PAID gần nhất)</h6>
                    <a href="javascript:void(0)">Show All</a>
                </div>

                @if (recentPaidOrders.Count == 0)
                {
                    <div class="text-muted">Chưa có đơn PAID.</div>
                }
                else
                {
                    foreach (var x in recentPaidOrders)
                    {
                        <div class="d-flex align-items-center border-bottom py-2">
                            <input class="form-check-input m-0" type="checkbox" />
                            <div class="w-100 ms-3">
                                <div class="d-flex w-100 align-items-center justify-content-between">
                                    <span class="text-start">
                                        <b>@(x.UserName ?? "Khách")</b> vừa mua •
                                        @("₫" + Convert.ToInt64(x.TotalAmount ?? 0).ToString("N0"))
                                    </span>
                                    <small class="text-muted">
                                        @(((DateTime?)(x.PaidAt ?? x.CreatedAt))?.ToString("dd/MM HH:mm"))
                                    </small>
                                </div>
                                <div class="small text-muted text-start">
                                    Order #@(x.OrderId)
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

<!-- Footer (giữ template) -->
<div class="container-fluid pt-4 px-4">
    <div class="bg-secondary rounded-top p-4">
        <div class="row">
            <div class="col-12 col-sm-6 text-center text-sm-start">
                &copy; <a href="#">Your Site Name</a>, All Right Reserved.
            </div>
            <div class="col-12 col-sm-6 text-center text-sm-end">
                Designed By <a href="https://htmlcodex.com">HTML Codex</a>
                <br />Distributed By:
                <a href="https://themewagon.com" target="_blank">ThemeWagon</a>
            </div>
        </div>
    </div>
</div>
